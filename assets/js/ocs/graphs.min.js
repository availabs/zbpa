var OCS=OCS||{};OCS.Graphs=function(){var _this={debug:false,debug_class_name:"OCS.Graphs - ",settings:null,soil_mois_chart:null,output_chart:null,gGetSiteInfoObj:null,gMtsDataObj:null,gNewDataFunctionRunning:false,plot_lines_obj:[],defaults:{site:"nrmn",tooltip_container:"met_tooltip",graph_container:"graph",title:"Graph Title",data_resolution:5,duration:"1d",duration_values:[],data_names:[],data_types:[],y_axis_titles:[],y_axis_colors:["#C0D0E0","#C0D0E0"],y_axis_textcolors:["#000000","#000000"],y_axis_minbuffer:3,series_names:[],series_units:[],series_roundings:[],series_ranges:[],series_yaxis:[],plot_lines:[],mesonet_url:"http://www.mesonet.org/",mesonet_img_url:"http://www.mesonet.org/images/global/mesonet_logo_small.png",exporting_url:"/common/db/library/js/classes/Highcharts/2.3.5/exporting-server/index.php",data_url:"/index.php/meteogram/data/j_meteogram_data/"},init:function(e){_this.debug_console("START INIT!");_this.settings=_.extend(_this.defaults,e);_this.debug_console(_this.settings,true);_this.init_degree_sym();_this.init_duration()},draw_soil_moisture_graph:function(e){Highcharts.setOptions({global:{useUTC:false}});_this.soil_mois_chart=new Highcharts.Chart({chart:{renderTo:_this.settings.graph_container,alignTicks:false,animation:false,zoomType:"x"},credits:{href:_this.settings.mesonet_url,text:""},loading:{style:{backgroundColor:"transparent",opacity:.5},labelStyle:{color:"black"}},rangeSelector:{enabled:false},navigator:{enabled:false},title:{text:_this.settings.title},legend:{enabled:true},exporting:{enabled:true,url:_this.settings.exporting_url},plotOptions:{series:{marker:{enabled:false},threshold:-900},area:{shadow:false,states:{hover:{enabled:false}}},line:{shadow:false,states:{hover:{enabled:false}}}},tooltip:{enabled:true,shared:true,crosshairs:{width:1,zIndex:0},formatter:function(){var e=this.points[0].series.chart;var t=e.xAxis[0].series[0].xData;var n=0;while(this.x!==t[n]&&n<5e3){n++}tooltip_text=_this.create_tooltip_text(e,n,this.x);$("#"+_this.settings.tooltip_container).html(tooltip_text);return false}},xAxis:[{dateTimeLabelFormats:{second:"%l:%M:%S %p",minute:"%l:%M %p<br/>%m/%d/%Y",hour:"%l:%M %p<br/>%m/%d/%Y",day:"%m/%d/%Y",week:"%m/%d/%Y",month:"%l:%M %p<br/>%m/%d/%Y",year:"%l:%M %p<br/>%m/%d/%Y"},tickLength:5,tickWidth:1,lineWidth:1,tickPixelInterval:144,type:"datetime",showEmpty:true,minRange:7*24*3600*1e3,labels:{style:{color:"#545454",fontSize:"9px"}}}],yAxis:[{title:{text:_this.settings.y_axis_titles[0],style:{background:"#ffffff"}},lineWidth:2,startOnTick:false,endOnTick:false,showEmpty:true,tickColor:"#C0C0C0",tickLength:5,tickWidth:1,tickPixelInterval:36,min:-.05,max:1.05,showLastLabel:true,gridLineWidth:.5,offset:0,labels:{align:"right",y:4,x:-7,style:{color:"#545454",fontSize:"9px"},formatter:function(){return this.value+""}}}],series:[{type:"line",name:_this.settings.series_names[0],data:_this.get_single_dataset(e,"FW05"),yAxis:0,xAxis:0,animation:false,color:"#ff0000"},{type:"line",name:_this.settings.series_names[1],data:_this.get_single_dataset(e,"FW25"),yAxis:0,xAxis:0,animation:false,color:"#FFCC00"},{type:"line",name:_this.settings.series_names[2],data:_this.get_single_dataset(e,"FW60"),yAxis:0,xAxis:0,animation:false,color:"#00ff00"}]})},draw_graph:function(){var e=_this.settings.site;var t=_this.settings.duration;var n=400;var r=new Array;var r=_this.populate_data(_this.gMtsDataObj);var i=_this.create_series_obj(r);yaxis_min_values=_this._get_overall_yaxis_min(r);_this.plot_lines_obj=_this.create_plotlines();var s=_this.create_y_axis_object(r,yaxis_min_values);Highcharts.setOptions({global:{useUTC:false}});_this.output_chart=new Highcharts.Chart({chart:{renderTo:_this.settings.graph_container,alignTicks:false,animation:false,spacingBottom:20,zoomType:"x",events:{load:function(e){this.renderer.image(_this.settings.mesonet_img_url,650,380,81,20).attr({zIndex:0}).add()}}},credits:{href:_this.settings.mesonet_url,text:""},loading:{style:{backgroundColor:"transparent",opacity:.5},labelStyle:{color:"black"}},rangeSelector:{enabled:false},navigator:{enabled:false},title:{text:_this.settings.title},legend:{enabled:true},exporting:{enabled:true,url:_this.settings.exporting_url},plotOptions:{series:{marker:{enabled:false}},area:{shadow:false,states:{hover:{enabled:false}}},line:{shadow:false,states:{hover:{enabled:false}}}},tooltip:{enabled:true,shared:true,crosshairs:{width:1,zIndex:0},formatter:function(){var e=this.points[0].series.chart;var t=e.xAxis[0].series[0].xData;var n=0;while(this.x!==t[n]&&n<5e3){n++}tooltip_text=_this.create_tooltip_text(e,n,this.x);$("#"+_this.settings.tooltip_container).html(tooltip_text);return false}},xAxis:[{dateTimeLabelFormats:{second:"%l:%M:%S %p",minute:"%l:%M %p<br/>%m/%d/%Y",hour:"%l:%M %p<br/>%m/%d/%Y",day:"%l:%M %p<br/>%m/%d/%Y",week:"%l:%M %p<br/>%m/%d/%Y",month:"%l:%M %p<br/>%m/%d/%Y",year:"%l:%M %p<br/>%m/%d/%Y"},tickLength:4,tickWidth:1,lineWidth:1,type:"datetime",showEmpty:true,labels:{style:{color:"#343434",fontSize:"9px"}}}],yAxis:s,series:i})},get_single_dataset:function(mtsJsonData,dataset_name){data_array=[];$.each(mtsJsonData.Soil_moisture,function(i){dataPoint=[parseInt(i*1e3),parseFloat(eval("this."+dataset_name))];if(dataPoint[1]<-950){dataPoint[1]=null}data_array.push(dataPoint)});return data_array},init_refreshing_graph:function(){var e=_this.settings.site;document.getElementById("stid").value=e;_this.gGetSiteInfoObj=new GetSitesInfoObject("/find/siteinfo-json");_this.gGetSiteInfoObj.RunAfterGettingData=function(){var e=document.getElementById("stid");var t=e.value;e.length=0;var n=_this.gGetSiteInfoObj.siteList.sort(function(e,t){return _this.gGetSiteInfoObj.siteJson[e]["name"].toLowerCase()<_this.gGetSiteInfoObj.siteJson[t]["name"].toLowerCase()?-1:1});for(var r in n){var i=_this.gGetSiteInfoObj.siteList[r];e.options[r]=new Option(_this.gGetSiteInfoObj.siteJson[i]["name"],i);if(t==i){e.options.selectedIndex=r}}_this.get_data_draw_graph();document.getElementById("stid").onchange=function(){_this.get_data_draw_graph()}};_this.gGetSiteInfoObj.GetData()},get_data_draw_graph:function(){_this.showSpinner();_this.gMtsDataObj=new GetMtsDataObject(_this.settings.data_url,_this.gGetSiteInfoObj);_this.gMtsDataObj.RunAfterGettingData=function(){_this.draw_graph();_this.hideSpinner()};_this.gMtsDataObj.GetData(_this.settings.site.toLowerCase(),_this.settings.duration,_this.settings.data_resolution)},addChangeDataPoint:function(e,t){for(i in t.data){if(t.data[i]["x"]==e[0]){if(t.data[i]["y"]==e[1]){return t}else{t.data[i].update(e[1]);return t}}}t.addPoint([e[0],e[1]],false,true,false);return t},populate_data:function(e){var t=new Array;$.each(_this.settings.data_names,function(n,r){t[r]=e?e.GetParamData(r):null;_this.debug_console(r);_this.debug_console(t[r],true)});return t},_get_min_no_null:function(e){if(e){min=999;for(i=0;i<e.length;i++){var t=e[i][1]!==null;if(e[i][1]&&e[i][1]!==null){min=e[i][1]<min?e[i][1]:min}}return min}},_get_overall_yaxis_min:function(e){var t=e;var n=[];n[0]=false;n[1]=false;var r=[];r[0]=undefined;r[1]=undefined;$.each(_this.settings.data_types,function(e,t){if(t=="area"){n[_this.settings.series_yaxis[e]]=true}});for(var i=0;i<=1;i++){if(n[i]){r[i]=9999;$.each(_this.settings.series_yaxis,function(e,n){if(n==i){temp_min=_this._get_min_no_null(t[_this.settings.data_names[e]]);if(temp_min<r[i]){r[i]=temp_min}}})}}_this.debug_console(r,true);return r},init_tooltip:function(){var e=0;var t=0;var n=5;var r=265;var i=20;var s=.11;var o=.89;var u=.66;$("#"+_this.settings.graph_container).mousemove(function(a){var f=$("#"+_this.settings.graph_container).offset();var l=a.pageX-f.left;var c=a.pageY-f.top;var h=Math.floor(Math.abs((c-n)/r));h=h>4?4:h;e=h*r+n;var p=$("#"+_this.settings.graph_container).width();var d=$("#"+_this.settings.tooltip_container).width();var v=l/p>u?true:false;var m=l/p<s?true:false;var g=l/p>o?true:false;if(v){if(g){t=o*p-i-d}else{t=l-i-d}}else{if(m){t=s*p+i}else{t=l+i}}$("#"+_this.settings.tooltip_container).css("top",e).css("left",t)});$(".product_map").mouseleave(function(e){$("#"+_this.settings.tooltip_container).css("display","none")});$(".product_map").mouseenter(function(e){$("#"+_this.settings.tooltip_container).css("display","inline")});$("#"+_this.settings.tooltip_container).mousemove(function(e){var n=$("#"+_this.settings.graph_container).offset();var r=e.pageX-n.left;var a=$("#"+_this.settings.graph_container).width();var f=$("#"+_this.settings.tooltip_container).width();var l=r/a>u?true:false;var c=r/a<s?true:false;var h=r/a>o?true:false;if(l){if(h){t=o*a-i-f}else{t=r-i-f}}else{if(c){t=s*a+i}else{t=r+i}}$("#"+_this.settings.tooltip_container).css("left",t)})},init_duration:function(){duration_html="";$.each(_this.settings.duration_values,function(e,t){unit=t.slice(-1);duration_string=t.slice(0,-1);unit_string="";switch(unit){case"m":if(duration_string=="1"){unit_string=" Minute"}else{unit_string=" Minutes"}break;case"h":if(duration_string=="1"){unit_string=" Hour"}else{unit_string=" Hours"}break;case"d":if(duration_string=="1"){unit_string=" Day"}else{unit_string=" Days"}break;case"w":if(duration_string=="1"){unit_string=" Week"}else{unit_string=" Weeks"}break;default:if(duration_string=="1"){unit_string=" Day"}else{unit_string=" Days"}break}duration_html+="<option value='"+t+"' ";if(_this.settings.duration==t){duration_html+='selected="selected"'}duration_html+=">"+duration_string+unit_string+"</option>"});$("#duration").html(duration_html)},init_degree_sym:function(){$.each(_this.settings.y_axis_titles,function(e,t){_this.settings.y_axis_titles[e]=t.replace("¡","¡")});_this.settings.title=_this.settings.title.replace("¡","¡")},create_tooltip_text:function(e,t,n){var r="<b>"+Highcharts.dateFormat("%m/%d/%Y - %l:%M %p",n)+"</b>";$.each(e.series,function(e,n){if(n.name=="NULL"){return true}seriesValue="--";seriesColor="#DDDDDD";if(n.yData[t]!==null){seriesColor=n.color;seriesValue=parseFloat(n.yData[t]).toFixed(_this.settings.series_roundings[e])}seriesName=_this.settings.series_names[e];r+='<div class="meteogram_tooltip_line"><div class="meteogram_tooltip_label" style="color:'+seriesColor+'">'+seriesName+"</div> ";r+='<div class="meteogram_tooltip_data">'+seriesValue+" "+_this.settings.series_units[e]+"</div></div>"});return r},create_plotlines:function(){plot_lines_output=[];$.each(_this.settings.plot_lines,function(e,t){new_plot_line=null;if(t.freezing){new_plot_line={value:32,width:1,color:"blue",dashStyle:"dash",zIndex:4,label:{style:{fontSize:"9px"},text:"32¡ F",align:"left",y:-2,x:0}}}plot_lines_output.push(new_plot_line)});_this.debug_console(plot_lines_output,true);return plot_lines_output},create_y_axis_object:function(e,t){y_axis_output=[];var n=e;var r=999999;$.each(_this.settings.y_axis_titles,function(e,n){if(e==0){new_y_axis={title:{text:_this.settings.y_axis_titles[e],style:{background:"#ffffff"}},opposite:false,lineWidth:2,startOnTick:false,endOnTick:false,showEmpty:true,tickColor:_this.settings.y_axis_colors[e],lineColor:_this.settings.y_axis_colors[e],tickLength:5,tickWidth:1,tickPixelInterval:36,showLastLabel:true,gridLineWidth:.5,offset:0,labels:{align:"right",y:4,x:-7,style:{color:_this.settings.y_axis_textcolors[e],fontSize:"9px"},formatter:function(){return this.value+""}}}}else if(e==1){new_y_axis={title:{text:_this.settings.y_axis_titles[e],style:{background:"#ffffff"}},opposite:true,lineWidth:2,startOnTick:false,endOnTick:false,showEmpty:true,tickColor:_this.settings.y_axis_colors[e],lineColor:_this.settings.y_axis_colors[e],tickLength:5,tickWidth:1,tickPixelInterval:36,showLastLabel:true,gridLineWidth:0,offset:0,labels:{align:"left",y:4,x:7,style:{color:_this.settings.y_axis_textcolors[e],fontSize:"9px"},formatter:function(){return this.value+""}}}}if(_this.plot_lines_obj[e]!==null&&_this.plot_lines_obj[e]!==undefined){new_y_axis["plotLines"]=[_this.plot_lines_obj[e]]}if(t[_this.settings.series_yaxis[e]]!==undefined){new_y_axis["min"]=t[_this.settings.series_yaxis[e]]-_this.settings.y_axis_minbuffer}if(_this.settings.series_ranges[e]!==null&&_this.settings.series_ranges[e]!==undefined){new_y_axis["min"]=_this.settings.series_ranges[e]["min"];new_y_axis["max"]=_this.settings.series_ranges[e]["max"]}y_axis_output.push(new_y_axis)});_this.debug_console("y_axis output");_this.debug_console(y_axis_output,true);return y_axis_output},create_series_obj:function(e){series_output=[];$.each(_this.settings.data_names,function(t,n){series_item={type:_this.settings.data_types[t],name:_this.settings.series_names[t],data:e[n],yAxis:_this.settings.series_yaxis[t],xAxis:0,animation:false,color:_this.settings.series_colors[t]};series_output.push(series_item)});_this.debug_console("series output");_this.debug_console(series_output,true);return series_output},showSpinner:function(){$('<div class="spinner"><img src="/images/ajax-loader.gif" style="vertical-align:-25%"> Loading...</div>').css({position:"absolute",display:"none",top:15,left:65,border:"1px solid #fdd",padding:"2px","background-color":"#fee",opacity:.8}).appendTo(".graph").fadeIn(200)},hideSpinner:function(){$(".spinner").remove()},debug_console:function(e,t){t=typeof t!=="undefined"?t:false;if(_this.debug){if(!t){console.log(_this.debug_class_name+e)}else{console.log(_this.debug_class_name);console.dir(e)}}}};return _this}()